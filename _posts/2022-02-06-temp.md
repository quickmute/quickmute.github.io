<#
Create SNS topic - nothing special
SNS: arn:aws:sns:us-east-1:999999999999:delete_me_hyon

Create IAM Role - 
IAM: arn:aws:iam::999999999999:role/delete_me_hyon
Permission:
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "sns:Publish"
            ],
            "Resource": "arn:aws:sns:us-east-1:999999999999:delete_me_hyon"
        }
    ]
}

Trust:
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "apigateway.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
#>
$ROLE_ARN = "arn:aws:iam::999999999999:role/delete_me_hyon"
$SNS_TOPIC_ARN = "arn:aws:sns:us-east-1:999999999999:delete_me_hyon"
$REGION = "us-east-1"

## Create a new rest api
$api_id = aws apigateway create-rest-api --name 'delete_me_hyon' --output text --query 'id' --region $REGION
## test it
aws apigateway get-resources --rest-api-id $API_ID
$root_resource_id = aws apigateway get-resources --rest-api-id $API_ID --output text --query 'items[0].id' --region $REGION
## see picture 1

##Create resource under root called my_ingest
$INGEST_RESOURCE_ID=aws apigateway create-resource --rest-api-id $API_ID --parent-id $ROOT_RESOURCE_ID --path-part my_ingest --output text --query 'id' --region $REGION
## see picture 2

# Create a method
aws apigateway put-method --rest-api-id $API_ID --resource-id $INGEST_RESOURCE_ID --http-method POST --authorization-type NONE --region $REGION

## see picture 3

#Put integration

$requesttemplates = '{\"application/json\":' +  '\"Action=Publish&TopicArn=$util.urlEncode(''' + $SNS_TOPIC_ARN + ''')&Message=$util.urlEncode($input.body)\"}'
aws apigateway put-integration `
  --rest-api-id $API_ID `
  --resource-id $INGEST_RESOURCE_ID `
  --http-method POST `
  --type AWS `
  --integration-http-method POST `
  --uri "arn:aws:apigateway:${REGION}:sns:path//" `
  --credentials $ROLE_ARN `
  --request-parameters '{\"integration.request.header.Content-Type\" : \"''application/x-www-form-urlencoded''\"}' `
  --request-templates $requesttemplates `
  --passthrough-behavior NEVER

<#
{
    "type": "AWS",
    "httpMethod": "POST",
    "uri": "arn:aws:apigateway:us-east-1:sns:path//",
    "credentials": "arn:aws:iam::999999999999:role/delete_me_hyon",
    "requestParameters": {
        "integration.request.header.Content-Type": "'application/x-www-form-urlencoded'"
    },
    "requestTemplates": {
        "application/json": "Action=Publish&TopicArn=$util.urlEncode('arn:aws:sns:us-east-1:999999999999:delete_me_hyon')&Message=$util.urlEncode($input.body)"
    },
    "passthroughBehavior": "NEVER",
    "timeoutInMillis": 29000,
    "cacheNamespace": "cvevrl",
    "cacheKeyParameters": []
}
#>


# See picture 4 & 5
aws apigateway put-integration-response `
--rest-api-id $API_ID `
--resource-id $INGEST_RESOURCE_ID `
--http-method POST `
--status-code 200 `
--response-templates '{\"application/json\": \"{''body'': ''Message received.''}\"}' 
#--selection-pattern '\"\"'
<#
{
    "statusCode": "200",
    "selectionPattern": "\"\"",
    "responseTemplates": {
        "application/json": "{'body': 'Message received.'}"
    }
}
#>

# See picture 6

aws apigateway put-method-response `
  --rest-api-id $API_ID `
  --resource-id $INGEST_RESOURCE_ID `
  --http-method POST `
  --status-code 200 `
  --response-models '{\"application/json\": \"Empty\" }'

<#
{
    "statusCode": "200",
    "responseModels": {
        "application/json": "Empty"
    }
}
#>
# see picture 7
   
aws apigateway create-deployment --rest-api-id $API_ID --stage-name prod

<#
{
    "id": "55n8z8",
    "createdDate": "2022-02-06T15:29:21-06:00"
}
#>

# see picture 8
$timestamp = get-date
Invoke-WebRequest -Headers @{"Content-Type"="application/json"} -Body $timestamp -Method POST -Uri https://q9Ofxwvudk.execute-api.us-east-1.amazonaws.com/PROD/my_ingest

